RFT-001 — Metrics Tab Consolidation (649213)\n\nDate: 2025-11-16 15:43 (Europe/Rome)\n\n### User story\n- As a project controller, I want a single Metrics page on Project, WBE, and Cost Element views so I can see Budget and Cost summaries (and related KPIs) together without switching tabs.\n\n### Scope\n- Merge “Budget Summary” and “Cost Summary” tabs into a single “Metrics” tab for:\n  - Project detail (`projects.$id`)\n  - WBE detail (`projects.$id.wbes.$wbeId`)\n  - Cost Element detail (`projects.$id.wbes.$wbeId.cost-elements.$costElementId`)\n- Preserve existing data fidelity and theming. Maintain URL-driven tab state/back-compat where feasible.\n\n---\n\n## 1) Codebase Pattern Analysis\n- Existing implementations and patterns\n  - Tabs & routing\n    - `frontend/src/routes/_layout/projects.$id.tsx` — uses `Tabs.Root`, `Tabs.List`, `Tabs.Trigger`, `Tabs.Content` from Chakra UI, with search param schema via `zod` and TanStack Router for navigation.\n    - `frontend/src/routes/_layout/projects.$id.wbes.$wbeId.tsx` — similar tabbed structure for WBE.\n    - `frontend/src/routes/_layout/projects.$id.wbes.$wbeId.cost-elements.$costElementId.tsx` — tabbed structure for Cost Element.\n  - Summary components\n    - `frontend/src/components/Projects/BudgetSummary.tsx` — fetches via `BudgetSummaryService` with `useQuery` and `useTimeMachine()`.\n    - `frontend/src/components/Projects/CostSummary.tsx` — fetches via `CostSummaryService` with `useQuery` and `useTimeMachine()`.\n  - Services (client SDK)\n    - `frontend/src/client/sdk.gen.ts` — `BudgetSummaryService`, `CostSummaryService` expose project/WBE/cost-element endpoints.\n  - Architecture layers\n    - UI components in `frontend/src/components/**`\n    - Route containers in `frontend/src/routes/_layout/**`\n    - Data layer via generated client + React Query\n    - Global time via `useTimeMachine()` context\n\n- Namespaces, interfaces, base classes (front-end)\n  - React components, Chakra UI primitives, `@tanstack/react-router` route modules\n  - Types from SDK: `BudgetSummaryPublic`, `CostSummaryPublic` (referenced by components)\n  - No classical inheritance; composition + hooks are the main patterns\n\n## 2) Integration Touchpoint Mapping\n- Route modules to modify\n  - `frontend/src/routes/_layout/projects.$id.tsx`: replace “Budget Summary” + “Cost Summary” triggers with single “Metrics” trigger; update search schema enum and content mapping.\n  - `frontend/src/routes/_layout/projects.$id.wbes.$wbeId.tsx`: same consolidation; ensure `EarnedValueSummary` placement remains sensible if included.\n  - `frontend/src/routes/_layout/projects.$id.wbes.$wbeId.cost-elements.$costElementId.tsx`: consolidate “Cost Summary” into “Metrics” (Cost Element view lacks BudgetSummary; metrics may show cost KPIs only).\n- Components\n  - Introduce `MetricsSummary` composition component that renders `BudgetSummary` and `CostSummary` side-by-side or stacked depending on level and availability.\n  - Consider optional inclusion of `EarnedValueSummary` for Project/WBE metrics (already shown within the Budget tab for WBE; confirm consistency at Project level).\n- System dependencies\n  - Generated SDK (`sdk.gen.ts`) for summaries\n  - React Query cache keys (must remain stable or get migration to avoid stale content)\n  - Time Machine context for `controlDate`\n- Config patterns\n  - Search params schemas via `zod` (tab enums) — must add “metrics”; optionally map old values to new for back-compat\n  - Tabs navigate via `onValueChange` and TanStack Router `search` params\n\n## 3) Abstraction Inventory\n- Reusable abstractions\n  - Summary components: `BudgetSummary`, `CostSummary`, `EarnedValueSummary`\n  - Query patterns: React Query + `useTimeMachine()`\n  - Layout: Chakra UI grid/box cards with theme-aware tokens\n- Dependency patterns\n  - Service calls encapsulated in SDK classes: `BudgetSummaryService`, `CostSummaryService`\n  - No DI container; components wire hooks/services directly\n- Test utilities\n  - Playwright e2e: `frontend/tests/project-cost-element-tabs.spec.ts` covers tab navigation (needs updates for “Metrics”)\n  - Component tests present for theming (e.g., `Projects/__tests__/CostSummary.theme.spec.tsx`)\n\n## 4) Alternative Approaches\n- Approach A: Single “Metrics” tab (compose summaries)\n  - What: Replace both tabs with one “Metrics” tab and render `BudgetSummary` + `CostSummary` together (and optionally `EarnedValueSummary` at Project/WBE).\n  - Pros: Simpler UX; fewer tab switches; minimal routing changes; aligns with “single page for KPIs”.\n  - Cons: Longer scroll; potential performance hit from multiple queries; needs responsive layout care.\n  - Alignment: Strong — reuses existing components and routing patterns.\n  - Complexity: Low–Medium.\n  - Risks: Caching/queries duplication, performance on low-end devices.\n\n- Approach B: “Metrics” tab with internal sub-tabs (local-only)\n  - What: One parent “Metrics” tab, with local sub-tabs (not URL-level) to switch between Budget, Cost, Earned Value.\n  - Pros: Keeps focused views; avoids URL churn; easy composition.\n  - Cons: Deep-linking to sub-views harder; added UI within UI.\n  - Alignment: Medium — adds a local tab pattern within route.\n  - Complexity: Medium.\n  - Risks: Accessibility and nested tab semantics, test updates.\n\n- Approach C: URL sub-route for metrics (e.g., `tab=metrics&view=budget|cost`)\n  - What: Keep a single “Metrics” parent at UI, but add a secondary `view` search param for deep-linking.\n  - Pros: Best shareability; preserves direct links to old sections via mapping.\n  - Cons: More routing/schema work; added test surface.\n  - Alignment: Strong with current router patterns.\n  - Complexity: Medium–High.\n  - Risks: Back-compat and redirects, validation edge cases.\n\n## 5) Architectural Impact Assessment\n- Principles followed\n  - Composition over duplication; reuse existing summaries and services\n  - Respect current routing, search schema, and theming practices\n- Potential violations / burdens\n  - If all summaries are rendered simultaneously, could increase data fetching and render costs; mitigate via `lazyMount`, visibility-based rendering, or query `enabled` guards\n  - URL back-compat: existing links/tests use `tab=summary` or `tab=cost-summary`\n- Testing challenges\n  - Update Playwright specs to reflect “Metrics” tab\n  - Ensure `useQuery` cache keys don’t cause stale state when both summaries mount together\n  - Snapshot/layout tests for responsive stacking\n\n## Recommended Direction\n- Choose Approach C (single “Metrics” tab + secondary `view` param) if deep linking to specific sub-views is critical and you want smooth migration. Otherwise, Approach A is the simplest and fastest.\n- For this iteration, default to Approach A (lowest complexity), and add a non-breaking mapping: if URL has old `tab=summary` or `tab=cost-summary`, route to `tab=metrics` (optionally scroll to the relevant section).\n\n## Ambiguities / Open Questions
- RESOLVED: Include `EarnedValueSummary` in Project-level Metrics (match WBE behavior).
- RESOLVED: For Cost Element metrics (which lack budget), label remains “Metrics”.
- RESOLVED: Use silent mapping of `tab=summary` and `tab=cost-summary` to `tab=metrics` (no redirect UI).

## Risks and Unknowns
- Performance from rendering multiple summary widgets concurrently
- Regression risk in tests relying on tab text and URL patterns
- Visual density/scroll on smaller screens; needs responsive grouping

## Constraints & References
- UI Library: Chakra UI Tabs (v3 pattern)
- Router: TanStack Router + `zod` search schema
- Data: React Query + generated SDK (`BudgetSummaryService`, `CostSummaryService`)

---

### Acceptance Criteria (High-level)
- A single “Metrics” tab is visible where Budget/Cost tabs were
- The Metrics tab shows Budget and Cost summaries (and EV where applicable)
- Old `tab=summary` and `tab=cost-summary` URLs still land users on the Metrics tab
- Tests updated to reflect the new tab and preserved deep-link behavior

### TDD Note
- Next step is to add failing tests updating Playwright specs and route schema unit tests for new `metrics` tab and URL mapping, before implementation.
*** End Patch
